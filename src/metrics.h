// Copyright (c) 2016 The Zcash developers
// Copyright (c) 2025 The Zclassic developers
// Distributed under the MIT software license, see the accompanying
// file COPYING or http://www.opensource.org/licenses/mit-license.php.

#include "uint256.h"
#include "consensus/params.h"

#include <atomic>
#include <mutex>
#include <string>

struct AtomicCounter {
    std::atomic<uint64_t> value;

    AtomicCounter() : value {0} { }

    void increment(){
        ++value;
    }

    void decrement(){
        --value;
    }

    int get() const {
        return value.load();
    }
};

class AtomicTimer {
private:
    std::mutex mtx;
    uint64_t threads;
    int64_t start_time;
    int64_t total_time;

public:
    AtomicTimer() : threads(0), start_time(0), total_time(0) {}

    /**
     * Starts timing on first call, and counts the number of calls.
     */
    void start();

    /**
     * Counts number of calls, and stops timing after it has been called as
     * many times as start().
     */
    void stop();

    bool running();

    uint64_t threadCount();

    double rate(const AtomicCounter& count);
};

extern AtomicCounter transactionsValidated;
extern AtomicCounter ehSolverRuns;
extern AtomicCounter solutionTargetChecks;
extern AtomicTimer miningTimer;

void TrackMinedBlock(uint256 hash);

void MarkStartTime();
double GetLocalSolPS();
int EstimateNetHeight(const Consensus::Params& params, int currentBlockHeight, int64_t currentBlockTime);

void TriggerRefresh();

void ConnectMetricsScreen();
void ThreadShowMetricsScreen();

/**
 * Heart image: https://commons.wikimedia.org/wiki/File:Heart_coraz%C3%B3n.svg
 * License: CC BY-SA 3.0
 *
 * Rendering options:
 * new ZCL logo: img2txt -W 88 -H 20 -f utf8 -d none contrib/newlogo.png > newlogo.ansi
 * Heart: img2txt -W 40 -H 20 -f utf8 -d none 2000px-Heart_coraz√≥n.svg.png
 */
#ifdef WIN32

    const std::string METRICS_ART =
    "   ____     ____\n"
    "       /   /    \\  |\n"
    "      /   |        |\n"
    "     /    |        |\n"
    "    /     |        |\n"
    "   /____   \\____/  |____\n";

#else

 const std::string METRICS_ART =
"               [0;1;30;90;43mXX[0;1;31;91;43m8[0;33;5;43;103m:...:[0;1;31;91;43m8[0;1;30;90;43mXS[0m                         [0;1;31;91;41mX[0;31;5;41;101m8XXX@[0;1;31;91;41m8[0m               [0;1;31;91;41m8[0;31;5;41;101mXXXX@[0m         \n"
"          [0;1;30;90;43m8[0;1;33;93;43m..[0;1;31;91;43m8[0;1;33;93;43m.............[0;1;31;91;43m8[0;1;33;93;43m..[0;1;30;90;43m8[0m                 [0;31;5;41;101m.            t[0m       [0;31;5;41;101mt             X[0m    \n"
"       [0;1;30;90;43m8[0;1;33;93;43m.[0;1;31;91;43m8[0;1;33;93;43m....[0;1;31;91;43m88[0;33;5;43;103m.[0;1;33;93;43m.[0;1;31;91;43m8[0;31;43mt[0;1;30;90;43mX[0;31;43mt[0;1;31;91;43m88[0;33;5;43;103m.[0;1;33;93;43m.[0;1;31;91;43m8[0;1;33;93;43m....[0;1;31;91;43m8[0;1;33;93;43m.[0;1;30;90;43m8[0m            [0;31;5;41;101m                 :[0m   [0;31;5;41;101m.                 t[0m  \n"
"     [0;1;30;90;43m8[0;1;33;93;43m......[0;1;31;91;43m8[0;1;30;90;43m8[0m              [0;1;31;91;43m8[0;1;33;93;43m......[0;1;30;90;43m8[0m        [0;31;5;41;101m%                    .                     [0m \n"
"    [0;33;5;43;103m.[0;1;33;93;43m....[0;33;5;43;103m.[0;1;30;90;43m8[0m                    [0;1;31;91;43m88[0;1;33;93;43m..[0;33;5;43;103m.:[0m       [0;31;5;41;101m                                           .[0m\n"
"   [0;1;31;91;43m8[0;1;33;93;43m....[0;33;5;43;103m.[0;1;30;90;43m8[0m                       [0;33;5;43;103m:.[0;1;33;93;43m..[0;33;5;43;103m.[0m     [0;31;5;41;101mX                                            [0m\n"
"  [0;1;31;91;43m8[0;1;33;93;43m................[0;1;31;91;43m8[0;37;43mX[0m [0;1;33;93;43m....[0;1;31;91;43m8[0;37;43mX[0m      [0;37;43m@[0;33;5;43;103m.[0;1;33;93;43m..[0;33;5;43;103m.[0m    [0;31;5;41;101mX                                            [0m\n"
" [0;33;5;43;103m.[0;1;33;93;43m....[0;33;5;43;103m.............[0;33;47m88[0;1;31;91;43m8[0;1;33;93;43m....[0m         [0;37;5;43;103m@[0;1;33;93;43m...[0;33;5;43;103m:[0m    [0;31;5;41;101m                                            [0m\n"
"[0;33;47m8[0;1;31;91;43m8[0;1;33;93;43m....[0m             [0;1;33;93;43m:[0;1;31;91;43m8[0;1;33;93;43m....[0m           [0;33;5;43;103m.[0;1;33;93;43m..[0;33;5;43;103m.[0;37;43m8[0m   [0;31;5;41;101m                                           [0m \n"
"[0;33;5;43;103m.[0;1;33;93;43m...[0;1;31;91;43m8[0m             [0;1;33;93;43m......[0m            [0;33;5;43;103m.[0;1;33;93;43m...[0;37;5;43;103m@[0m    [0;31;5;41;101m                                         .[0m \n"
"[0;33;5;43;103m.[0;1;33;93;43m...[0;1;31;91;43m8[0m            [0;1;33;93;43m......[0m             [0;33;5;43;103m.[0;1;33;93;43m...[0;33;5;43;103m.[0m     [0;31;5;41;101m                                       ;[0m  \n"
"[0;37;43m@[0;1;31;91;43m8[0;1;33;93;43m...[0;1;31;91;43m8[0m          [0;33;5;43;103m.[0;1;33;93;43m...[0;1;31;91;43m8[0;1;33;93;43m:[0m              [0;33;5;43;103m.[0;1;33;93;43m..[0;33;5;43;103m.[0;33;47m8[0m      [0;31;5;41;101m.                                    [0m    \n"
" [0;1;33;93;43m.....[0m         [0;1;33;93;43m.....[0;1;31;91;43m8[0;33;5;43;103m................[0;1;33;93;43m..[0;33;5;43;103m:[0m         [0;31;5;41;101m.                               .[0m      \n"
"  [0;1;31;91;43m8[0;1;33;93;43m...[0;33;5;43;103m.[0m      [0;37;43m@[0;1;33;93;43m...................[0;1;31;91;43m8[0;33;5;43;103m..[0;1;33;93;43m..[0;33;5;43;103m.[0m            [0;31;5;41;101m:                           t[0m        \n"
"  [0;1;30;90;43m8[0;1;31;91;43m8[0;1;33;93;43m....[0m     [0;31;43mSSSSSSSSSSSSSSSSSS[0;1;30;90;43mX[0;33;5;43;103m:..[0;1;33;93;43m..[0;33;5;43;103m.[0m               [0;31;5;41;101mt                       S[0m          \n"
"    [0;1;33;93;43m....[0;1;31;91;43m8[0;1;33;93;43m.[0m                     [0;1;31;91;43m88[0;33;5;43;103m...:[0m                  [0;1;31;91;41m8[0;31;5;41;101m                   [0;1;31;91;41m8[0m            \n"
"     [0;1;31;91;43m88[0;1;33;93;43m.....[0;1;30;90;43m8[0m               [0;1;30;90;43m8[0;1;33;93;43m.[0;1;31;91;43m8[0;1;33;93;43m...[0;1;31;91;43m8[0;37;43m@[0m                      [0;31;5;41;101m:             :[0m               \n"
"       [0;1;30;90;43m8[0;33;5;43;103m.[0;1;33;93;43m.....[0;1;31;91;43m8[0;33;5;43;103m.[0;1;33;93;43m.[0;1;31;91;43m8[0;31;43mS[0;1;30;90;43m@X8[0;31;43mS[0;1;30;90;43mX[0;1;31;91;43m8[0;33;5;43;103m.[0;1;31;91;43m8[0;1;33;93;43m.....[0;33;5;43;103m.[0;1;30;90;43m8[0m                          [0;31;5;41;101mt         X[0m                 \n"
"          [0;1;30;90;43mX[0;33;5;43;103m.[0;1;31;91;43m8[0;1;33;93;43m...............[0;1;31;91;43m8[0;33;5;43;103m.[0;1;30;90;43m@[0m                               [0;1;31;91;41m8[0;31;5;41;101m     [0;1;31;91;41m8[0m                   \n"
"               [0;1;30;90;43mX[0;1;31;91;43m8[0;33;5;43;103m.......[0;1;31;91;43m8[0;1;30;90;43mX[0m                                       [0;31;5;41;101m.[0m                      \n";

#endif

